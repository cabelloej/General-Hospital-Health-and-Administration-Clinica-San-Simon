STORE "ACTUALIZANDO ALMACEN, FAVOR ESPERAR..." TO MES
DO MENSAJE WITH MES
STORE .T. TO REVERSA
DO WHILE REVERSA
   SELECT MATTRA
   SET ORDER TO MATTRA3
   STORE WNUMERO2 TO WXX
   SEEK WXX
   IF EOF()
      EXIT
   ENDIF
   STORE CODIGO   TO WCODIGO
   STORE UNIDADES TO WUNIDADES
   STORE COSTO    TO WCOSTO
   IF RECLOC()
      DELETE
      UNLOCK ALL
   ELSE
      STORE "ACTUALIZACION DE ALMACEN ABORTADA, FAVOR REINTENTAR" TO MES
      DO AVISO WITH MES
      STORE .F. TO REVERSA
      EXIT
   ENDIF
   IF WCODIGO = SPACE(20)
      STORE "ERROR, CODIGO DE ARTICULO VACION EN TRANS. ALM., VERIFIQUE" TO MES
      DO AVISO WITH MES
      LOOP
   ENDIF
   SELECT MATART
   FIND &WCODIGO
   IF EOF()
      STORE "CODIGO DE ART:"+RTRIM(WCODIGO)+", EN MOV. NO EXISTE EN ALMACEN, VERIFIQUE" TO MES
      DO AVISO WITH MES
      LOOP
   ENDIF
   IF RECLOC()
      IF SUBSTR(WNUMERO2,1,3)="DEV"
         IF UNIEXI + WUNIDADES > 0
            REPLACE COSEXI WITH ((COSEXI*UNIEXI)+(WCOSTO)) / (UNIEXI+WUNIDADES)
         ELSE
            REPLACE COSEXI WITH 0
         ENDIF
         REPLACE UNIEXI WITH UNIEXI + WUNIDADES
      ELSE
        IF SUBSTR(WNUMERO2,1,3)="NOT"
           IF UNIEXI + WUNIDADES > 0
              REPLACE COSEXI WITH ((COSEXI*UNIEXI)+(WCOSTO)) / (UNIEXI+WUNIDADES)
           ELSE
              REPLACE COSEXI WITH 0
           ENDIF
           REPLACE UNIEXI WITH UNIEXI + WUNIDADES
        ENDIF
      ENDIF
      UNLOCK ALL
      FLUSH
   ELSE
      STORE "OPERACION ABORTADA EN CALCULO DE COSTO. REINTENTE" TO MES
      DO AVISO WITH MES
   ENDIF
ENDDO
IF .NOT.REVERSA
   RETURN
ENDIF

*** GRABA LOS MOVIMIENTOS DE ALMACEN
SELECT MATDCDE
GO TOP
FIND &WNUMERO2
DO WHILE .NOT. EOF() .AND. NUMERO = WNUMERO2
   STORE ITEM     TO WITEM
   STORE ITEM     TO WCODIGO
   STORE CANTIDAD TO WCANTIDAD
   STORE COSTO    TO WCOSTO
   IF WITEM = SPACE(20)
      STORE "ERROR, CODIGO DE ARTICULO VACIO EN RENGLONES. VERIFIQUE" TO MES
      DO AVISO WITH MES
      SKIP
      LOOP
   ENDIF
   SELECT MATART
   FIND &WITEM
   IF EOF()
      STORE "ERROR, ARTI: "+RTRIM(WITEM)+" DOC.:"+WNUMERO2+" NO EXISTE EN ALMACEN" TO MES
      DO AVISO WITH MES
      SELECT MATDCDE
      SKIP
      LOOP
   ENDIF
   STORE (COSEXI*UNIEXI)      TO WCOSTACT
   STORE (WCOSTO*WCANTIDAD)   TO WCOSTFAC
   *STORE "ART:"+ALLTRIM(WITEM)+;
   *      " COS:"+ALLTRIM(STR(WCOSTO,10,2))+;
   *      " CAN:"+ALLTRIM(STR(WCANTIDAD,10,2))+;
   *      " FAC:"+ALLTRIM(STR(WCOSTFAC,12,2)) TO MES
   *      DO AVISO WITH MES
   IF RECLOC()
      IF SUBSTR(WNUMERO2,1,3)="DEV"
         IF UNIEXI+WCANTIDAD>0
            REPLACE COSEXI WITH (WCOSTACT+WCOSTFAC)/(UNIEXI+WCANTIDAD)
            REPLACE UNIEXI WITH UNIEXI + WCANTIDAD
         ELSE
            REPLACE UNIEXI WITH 0
            REPLACE COSEXI WITH 0
         ENDIF
      ELSE
         IF UNIEXI-WCANTIDAD>0     
            REPLACE COSEXI WITH (WCOSTACT-WCOSTFAC)/(UNIEXI-WCANTIDAD)
            REPLACE UNIEXI WITH UNIEXI - WCANTIDAD
         ELSE
            REPLACE COSEXI WITH 0
            REPLACE UNIEXI WITH 0
         ENDIF
      ENDIF
      FLUSH
      UNLOCK ALL
   ELSE
      STORE "OPERACION ABORTADA EN RECALCULO DE COSTO, REINTENTE" TO MES
      DO AVISO WITH MES
      SELECT MATDCDE
      SKIP
      LOOP
   ENDIF
   SELECT MATTRA
   IF FILLOC()
      append blank
      REPLACE SERIAL     WITH MATDATA->SERIAL+1
      replace codigo     with MATDCDE->ITEM
      replace fecha      with MATDCGE->ELABORADO
      IF SUBSTR(WNUMERO2,1,3)="DEV"
         replace operacion  with "DS"
      ELSE
         IF SUBSTR(WNUMERO2,1,3)="NOT"
            REPLACE OPERACION WITH "SA"
         ENDIF
      ENDIF
      replace referencia with MATDCGE->NUMERO
      replace origen     with "MAT"
      REPLACE PROCLI     WITH MATDCGE->PARA
      REPLACE UNIDADES   WITH WCANTIDAD
      REPLACE COSTO      WITH WCOSTFAC
      UNLOCK ALL
      FLUSH
      SELECT MATDATA
      IF RECLOC()
         REPLACE SERIAL WITH SERIAL+1
         UNLOCK ALL
         FLUSH
      ENDIF
   ELSE
      STORE "OPERACION ABORTADA, REPROCESE ALMACEN Y ESTE DOCUMENTO" TO MES
      DO AVISO WITH MES
   ENDIF
   SELECT MATDCDE
   SKIP
ENDDO 
RETURN

